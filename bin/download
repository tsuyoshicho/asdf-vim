#!/usr/bin/env bash

download_vim() {
	local install_type
	local version
	local download_path
	install_type=$1
	version=$2
	download_path=$3

	local tmp_download_dir
	if [ "${TMPDIR}" = "" ]; then
		tmp_download_dir=$(mktemp -d -t asdf_vim_build_XXXXXX)
	else
		tmp_download_dir="${TMPDIR}"
	fi

	# path to the tar file
	if [ "${install_type}" = "version" ]; then
		local source_path
		source_path=$(get_download_file_path "${version}" "${tmp_download_dir}")
		echo "${source_path}"
		download_source_file "${version}" "${source_path}"

		if ! type "tar" &>/dev/null; then
			echo "ERROR: tar not found"
			exit 1
		fi

		tar -xvf "${source_path}" -C "${download_path}" || exit 1
	else
		echo "ERROR: git ref not supported"
		exit 1
	fi

	return
}

download_source_file() {
	local version
	local download_path
	local download_url
	version=$1
	download_path=$2
	download_url=$(get_download_url "${version}")

	printf "[asdf-vim] Downloading from: %s\n" "$download_url" >&2

	# Execute curl with error handling
	if ! curl -Lo "${download_path}" -C - "${download_url}"; then
		printf "[asdf-vim] curl failed with exit code %d\n" "$?" >&2
		rm -f "$download_path"
		exit 1
	fi

	# Verify downloaded file exists
	if [ ! -f "$download_path" ]; then
		printf "[asdf-vim] Downloaded file not found: %s\n" "$download_path" >&2
		exit 1
	fi

	# Check file size (too small = error response)
	local file_size
	file_size=$(stat -c%s "$download_path" 2>/dev/null || echo "0")

	if [ "$file_size" -lt 1000 ]; then
		printf "[asdf-vim] Downloaded file too small (%d bytes): %s\n" "$file_size" "$download_path" >&2
		printf "[asdf-vim] This may indicate an HTTP error response (404, 5xx, etc.)\n" >&2
		rm -f "$download_path"
		exit 1
	fi

	printf "[asdf-vim] Downloaded successfully (%d bytes)\n" "$file_size" >&2
	return
}

get_download_file_path() {
	local version
	local tmp_download_dir
	version=$1
	tmp_download_dir=$2

	echo "${tmp_download_dir}/vim-${version}.tar.gz"
	return
}

get_download_url() {
	local version
	version=$1

	# version が "latest" を含む場合は警告
	# Warn if version contains "latest"
	if [[ "${version}" == *"latest"* ]]; then
		printf "[asdf-vim] WARNING: version contains 'latest': %s\n" "$version" >&2
		printf "[asdf-vim] this suggests version resolution may have failed\n" >&2
	fi

	if [[ "${version}" =~ ^[0-9]+\.* ]]; then
		# if version is a release number, prepend v
		echo "https://github.com/vim/vim/archive/v${version}.tar.gz"
	else
		# otherwise it can be a branch name or commit sha
		echo "https://github.com/vim/vim/archive/${version}.tar.gz"
	fi
	return
}

download_vim "${ASDF_INSTALL_TYPE}" "${ASDF_INSTALL_VERSION}" "${ASDF_DOWNLOAD_PATH}"
